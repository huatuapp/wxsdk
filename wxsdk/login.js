const app = getApp(); var WXBizDataCrypt = require('cryptojs/RdWXBizDataCrypt.js'); import common from 'common.js'; const session_key_url = "wxapp/user/wx_session_key"; const session_key_wxRequest = (params) => common.wxRequest(params, session_key_url); const login_url = "wxapp/user/login"; const login_wxRequest = (params) => common.wxRequest(params, login_url); function login(e) { return new Promise(function (logFlag) { var session_key = wx.getStorageSync('session_key'); var pc = new WXBizDataCrypt(app.globalData.appid, session_key); var userdata = pc.decryptData(e.detail.encryptedData, e.detail.iv); var wxUserInfo = { "openId": userdata.openId, "unionId": userdata.unionId, "nickName": userdata.nickName, "gender": userdata.gender, "avatarUrl": userdata.avatarUrl }; if (wxUserInfo.unionId == "" || wxUserInfo.unionId == null) { wxUserInfo.unionId == wxUserInfo.openId } wx.setStorageSync('wxUserInfo', wxUserInfo); var logdata = { "unionid": wxUserInfo.unionId }; login_wxRequest({ data: logdata, method: 'POST', success: function (res) { if (res.data.code == '200') { wx.setStorageSync('userinfo', res.data.data); logFlag({ "code": 200, "userinfo": res.data.data }) } else { logFlag({ "code": -101, "userinfo": {} }) } }, fail: function (err) { logFlag({ "code": 0, "userinfo": {} }) } }) }) } function bindMobileCode(encryptedData, iv) { return new Promise(function (userinfo) { var session_key = wx.getStorageSync('session_key'); var pc = new WXBizDataCrypt(app.globalData.appid, session_key); var phoneinfo = pc.decryptData(encryptedData, iv); wx.getStorage({ key: 'wxUserInfo', success: function (res) { if (res.errMsg == "getStorage:ok") { var logdata = { "unionid": res.data.unionId, "mobile": phoneinfo.phoneNumber }; login_wxRequest({ data: logdata, method: 'POST', success: function (res) { if (res.data.code == '200') { wx.setStorageSync('userinfo', res.data.data); userinfo(res.data.data) } else { userinfo({}) } }, fail: function (err) { userinfo({}) } }) } else { userinfo({}) } }, fail: function () { userinfo({}) } }) }) } module.exports.login = login; module.exports.bindMobileCode = bindMobileCode